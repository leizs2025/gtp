<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>手机快递查询</title>
    <style>
        /* (原有样式保持不变) */
    </style>
</head>
<body>
    <h1>快递查询系统</h1>

    <div class="form-section">
        <div class="input-group">
            <label class="input-label">快递单号</label>
            <input type="text" id="trackingNumber" placeholder="输入快递单号">
        </div>
        <button type="button" onclick="queryData()">立即查询</button>
    </div>

    <div class="form-section">
        <div class="data-card">
            <div class="data-label">快递公司</div>
            <div id="companyData">-</div>
        </div>
        <div class="data-card">
            <div class="data-label">货物名称</div>
            <div id="productData">-</div>
        </div>
        <div class="data-card">
            <div class="data-label">客户名称</div>
            <div id="customerData">-</div>
        </div>
        <div class="data-card">
            <div class="data-label">已知运费</div>
            <div id="knownPrice">-</div>
        </div>
    </div>

    <div class="form-section">
        <div class="input-group">
            <label class="input-label">运费金额</label>
            <input type="number" id="enteredPrice" placeholder="输入运费金额">
        </div>
        <button type="button" onclick="submitForm()">确认提交</button>
    </div>

    <div id="result"></div>

    <script>
        const WORKER_URL = 'https://wandering-moon-bdc2.jeenty.workers.dev/'; // 👈 这里换成你的 Cloudflare Worker 地址

        function queryData() {
            const trackingNumber = document.getElementById('trackingNumber').value.trim();
            if (!trackingNumber) return alert('请输入快递单号');

            fetch(WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'query',
                    trackingNumber
                })
            })
            .then(res => res.json())
            .then(result => {
                updateResult(result, trackingNumber);
            })
            .catch(err => {
                document.getElementById('result').textContent = '查询失败，请稍后再试';
                console.error('查询失败:', err);
            });
        }

        function submitForm() {
            const trackingNumber = document.getElementById('trackingNumber').value.trim();
            const company = document.getElementById('companyData').textContent;
            const product = document.getElementById('productData').textContent;
            const customer = document.getElementById('customerData').textContent;
            const price = document.getElementById('enteredPrice').value.trim();

            if (!trackingNumber || !price) {
                alert('请填写完整信息');
                return;
            }

            fetch(WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'submit',
                    trackingNumber,
                    company,
                    product,
                    customer,
                    price
                })
            })
            .then(res => res.text())
            .then(result => {
                finalResult(result);
            })
            .catch(err => {
                document.getElementById('result').textContent = '提交失败，请稍后再试';
                console.error('提交失败:', err);
            });
        }

        function updateResult(result, trackingNumber) {
            const updateField = (id, value) => {
                document.getElementById(id).textContent = value || '-';
            };

            if (result && typeof result === 'object') {
                updateField('companyData', result.company);
                updateField('productData', result.product);
                updateField('customerData', result.customer);
                updateField('knownPrice', result.price);
                document.getElementById('result').textContent = '数据已提取，请填写运费并提交。';
            } else {
                document.getElementById('result').textContent = result || '查询失败';
                if (result === '未找到该快递单号！') {
                    ['companyData', 'productData', 'customerData', 'knownPrice'].forEach(id => {
                        updateField(id, '');
                    });
                }
            }
        }

        function finalResult(result) {
            document.getElementById('result').innerHTML = result;

            if (result.includes('成功')) {
                resetForm();
                setTimeout(() => {
                    document.getElementById('result').textContent = '';
                }, 2000);
            }
        }

        function resetForm() {
            document.getElementById('trackingNumber').value = '';
            document.getElementById('enteredPrice').value = '';
            ['companyData', 'productData', 'customerData', 'knownPrice'].forEach(id => {
                document.getElementById(id).textContent = '-';
            });
            document.getElementById('result').textContent = '';
        }
    </script>
</body>
</html>
