<script>
const API_URL = "https://wandering-moon-bdc2.jeenty.workers.dev/gas1";
let allRecords = [];
let pendingSubmissions = [], lastFetched = {}, matchedTrackingNumber = "";

function loadCache() {
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "all" })
  })
  .then(res => res.json())
  .then(data => {
    allRecords = data;
    showStatus("✅ 缓存加载成功，共 " + allRecords.length + " 条记录", "success");
  })
  .catch(() => showStatus("缓存加载失败", "error"));
}

function queryData() {
  const input = document.getElementById("trackingNumber").value.trim();
  if (!input) return alert("请输入快递单号");
  if (allRecords.length === 0) return showStatus("请先加载缓存", "error");

  let match = allRecords.find(item => item.trackingNumber === input);
  if (!match && input.length === 5) {
    match = allRecords.find(item => item.trackingNumber?.slice(-5) === input);
  }
  if (match) {
    lastFetched = match;
    matchedTrackingNumber = match.trackingNumber;
    updateDisplay(match);
  } else {
    showStatus("未在缓存中找到该快递单号", "error");
  }
}

function updateDisplay(data) {
  document.getElementById("companyData").textContent = data.company || "-";
  document.getElementById("productData").textContent = data.product || "-";
  document.getElementById("customerData").textContent = data.customer || "-";
  document.getElementById("knownPrice").textContent = data.price || "-";
  showStatus("✅ 查询成功", "success");
}

function addToCache() {
  const price = document.getElementById("enteredPrice").value.trim();
  const number = matchedTrackingNumber || document.getElementById("trackingNumber").value.trim();
  if (!price || !lastFetched.company || !number) return showStatus("请查询并填写金额", "error");

  const alreadyExists = pendingSubmissions.some(item => item.trackingNumber === number);
  if (alreadyExists) return showStatus("该快递单号已存在于缓存中", "error");

  pendingSubmissions.push({
    trackingNumber: number,
    company: lastFetched.company,
    customer: lastFetched.customer,
    product: lastFetched.product,
    enteredPrice: price
  });
  clearForm();
  renderPreview();
  showStatus("✅ 已加入缓存", "success");
}

function renderPreview() {
  const box = document.getElementById("previewList");
  box.innerHTML = "";
  pendingSubmissions.forEach((item, i) => {
    const line = document.createElement("div");
    line.innerHTML = `<div>${item.trackingNumber} - ${item.customer} - ${parseFloat(item.enteredPrice).toFixed(2)}</div><button class='del-btn' onclick='removeItem(${i})'>×</button>`;
    box.appendChild(line);
  });

  updateCustomerDropdown();

  const sel = document.getElementById("ticketSelector");
  const selectedCustomer = sel.value;
  const stillExists = pendingSubmissions.some(r => r.customer === selectedCustomer);
  if (!stillExists) sel.value = "";

  renderTicket();
}

function updateCustomerDropdown() {
  const uniqueNames = [...new Set(pendingSubmissions.map(r => r.customer))];
  const sel = document.getElementById("ticketSelector");
  sel.innerHTML = '<option value="">请选择客户</option>';
  uniqueNames.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

function removeItem(i) {
  pendingSubmissions.splice(i, 1);
  renderPreview();
}

function clearCache() {
  pendingSubmissions = [];
  renderPreview();
  clearForm();
  document.getElementById("ticketSelector").value = "";
  renderTicket();
  document.getElementById("ticketPreview").innerHTML = "";
  showStatus("缓存与表单清除成功", "success");
}

function clearForm() {
  document.getElementById("trackingNumber").value = "";
  document.getElementById("enteredPrice").value = "";
  document.getElementById("companyData").textContent = "-";
  document.getElementById("productData").textContent = "-";
  document.getElementById("customerData").textContent = "-";
  document.getElementById("knownPrice").textContent = "-";
  matchedTrackingNumber = "";
  lastFetched = {};
}

function submitAll() {
  if (pendingSubmissions.length === 0) return showStatus("缓存为空", "error");
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "submitBatch", list: pendingSubmissions })
  })
  .then(r => r.json())
  .then(res => {
    if (res.message) {
      showStatus(res.message, "success");
      pendingSubmissions = [];
      renderPreview();
      clearForm();
      document.getElementById("ticketSelector").value = "";
      renderTicket();
    } else {
      showStatus("提交失败", "error");
    }
  })
  .catch(() => showStatus("提交异常", "error"));
}

function renderTicket() {
  const name = document.getElementById("ticketSelector").value;
  const area = document.getElementById("ticketPreview");
  const filtered = pendingSubmissions.filter(r => r.customer === name);

  if (!name || filtered.length === 0) {
    area.innerHTML = "";
    area.style.display = "none";
    return;
  }

  area.style.display = "block";
  let total = 0;
  const date = new Date().toLocaleDateString();

  let rowsHtml = "";
  filtered.forEach((r, i) => {
    const price = parseFloat(r.enteredPrice).toFixed(2);
    total += parseFloat(price);
    rowsHtml += `<tr>
      <td style='width:5%'>${i + 1}.</td>
      <td style='width:55%'>${r.trackingNumber}</td>
      <td style='width:20%;text-align:left;'>${r.company}</td>
      <td style='width:20%;text-align:right;'>${price}</td>
    </tr>
    <tr>
      <td></td><td colspan='3'>${r.product}</td>
    </tr>`;
  });

  const contentHeight = 400;
  const rowHeight = 50;
  const requiredRows = Math.floor((contentHeight - 120) / rowHeight);
  const emptyRows = Math.max(0, requiredRows - filtered.length);

  let fillerRows = "";
  for (let i = 0; i < emptyRows; i++) {
    fillerRows += `<tr><td colspan='4'>&nbsp;</td></tr>`;
  }

  let html = `<div class='ticket-header'>体积费 & 包裹号<br>日期：${date}<br>客户：${name}</div><br><table class='ticket-table'>`;
  html += rowsHtml + fillerRows;
  html += `<tr><td colspan='4'><hr></td></tr>
           <tr><td colspan='4' class='ticket-summary'>合计：${filtered.length} 单，${total.toFixed(2)}</td></tr>`;
  html += `</table>`;
  area.innerHTML = html;
}

function downloadTicketAsImage() {
  const target = document.getElementById("ticketPreview");
  html2canvas(target).then(canvas => {
    const link = document.createElement("a");
    link.download = "ticket.jpg";
    link.href = canvas.toDataURL("image/jpeg");
    link.click();
  });
}

function showStatus(msg, type = "success") {
  const bar = document.getElementById("statusBar");
  bar.textContent = msg;
  bar.className = "status-bar " + type;
  bar.style.display = "block";
}
</script>
