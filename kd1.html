<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¿«é€’æŸ¥è¯¢ä¸æ‰¹é‡æäº¤ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0 auto;
      max-width: 860px;
      padding: 30px 20px;
      background-color: #ffffff;
      color: #333;
    }
    h1 { font-size: 1.8rem; margin-bottom: 2rem; text-align: center; }
    .section-title { font-size: 1.1rem; font-weight: 600; margin: 2rem 0 1rem; border-bottom: 1px solid #ddd; padding-bottom: 6px; }
    .input-group { margin-bottom: 1.2rem; }
    .input-label { font-weight: 500; display: block; margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc;
      border-radius: 4px; box-sizing: border-box;
    }
    button {
      padding: 10px 16px; font-size: 1rem; color: #fff;
      background-color: #007acc; border: none; border-radius: 4px; cursor: pointer;
    }
    button:hover { background-color: #005fa3; }
    .data-line { font-size: 0.95rem; margin: 6px 0; }
    .data-label { font-weight: 600; margin-right: 10px; color: #555; }
    #previewList div {
      display: flex; justify-content: space-between;
      padding: 6px 0; border-bottom: 1px solid #eee;
    }
    .del-btn { background: none; color: red; border: none; font-size: 18px; cursor: pointer; }
    .status-bar {
      padding: 10px; font-weight: bold; border-left: 4px solid;
      margin: 16px 0;
    }
    .success { background: #e0f8e9; color: #2c7a3f; border-color: #2c7a3f; }
    .error { background: #fdecea; color: #c0392b; border-color: #c0392b; }
    #ticketPreview {
      margin-top: 15px; padding: 12px; border: 1px dashed #bbb;
      background: #fafafa; font-size: 15px; line-height: 1.6;
      white-space: pre-wrap; display: none;
    }
    .ticket-table { width: 100%; border-collapse: collapse; font-size: 15px; }
    .ticket-table td { padding: 4px 0; vertical-align: top; }
    .ticket-header { font-weight: bold; text-align: center; margin-bottom: 10px; }
    .ticket-summary { text-align: right; font-weight: bold; margin-top: 10px; }
    .button-group {
      display: flex; justify-content: center;
      flex-wrap: wrap; gap: 10px; margin: 10px 0;
    }
    .inline-input {
      display: flex; gap: 10px;
    }
    .inline-input input, .inline-input select {
      flex: 1;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<h1>å¿«é€’æŸ¥è¯¢ä¸æ‰¹é‡æäº¤ç³»ç»Ÿ</h1>

<div class="input-label">å¿«é€’å•å·</div>
<div class="inline-input">
  <input type="text" id="trackingNumber" placeholder="è¾“å…¥å¿«é€’å•å·æˆ–å5ä½">
  <button onclick="queryData()">ğŸ” æŸ¥è¯¢</button>
  <button onclick="startScan()">ğŸ“· æ‰«ç </button>
</div>

<video id="scannerPreview" style="width:100%; max-height:300px; display:none; border:1px solid #ccc; margin-top:10px;" playsinline></video>

<div class="data-line"><span class="data-label">å¿«é€’å…¬å¸:</span> <span id="companyData">-</span></div>
<div class="data-line"><span class="data-label">è´§ç‰©åç§°:</span> <span id="productData">-</span></div>
<div class="data-line"><span class="data-label">å®¢æˆ·åç§°:</span> <span id="customerData">-</span></div>
<div class="data-line"><span class="data-label">å·²çŸ¥è¿è´¹:</span> <span id="knownPrice">-</span></div>

<div class="input-group">
  <label class="input-label">è¿è´¹é‡‘é¢</label>
  <input type="number" id="enteredPrice" placeholder="è¾“å…¥è¿è´¹é‡‘é¢">
</div>

<div class="button-group">
  <button onclick="addToCache()">â• åŠ å…¥ç¼“å­˜</button>
  <button onclick="loadCache()">ğŸ“¥ åŠ è½½ç¼“å­˜</button>
  <button onclick="submitAll()">ğŸ“¤ æäº¤å…¨éƒ¨è®°å½•</button>
  <button onclick="clearCache()" style="background:#e74c3c">ğŸ—‘ï¸ æ¸…ç©ºç¼“å­˜</button>
</div>

<div id="statusBar" class="status-bar" style="display:none;"></div>

<div class="section-title">ğŸ“‹ å·²ç¼“å­˜è®°å½•</div>
<div id="previewList"></div>

<div class="section-title">ğŸ§¾ ç­›é€‰å®¢æˆ·ç”Ÿæˆå°ç¥¨</div>
<div class="inline-input">
  <select id="ticketSelector" onchange="renderTicket()"><option value="">è¯·é€‰æ‹©å®¢æˆ·</option></select>
  <button onclick="downloadTicketAsImage()">ğŸ“¸ ä¸‹è½½å°ç¥¨æˆªå›¾</button>
</div>
<div id="ticketPreview"></div>

<script>
  const API_URL = "https://wandering-moon-bdc2.jeenty.workers.dev/gas1";
  let allRecords = [];
  let pendingSubmissions = [], lastFetched = {}, matchedTrackingNumber = "";
  
  function loadCache() {
    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "all" })
    })
    .then(res => res.json())
    .then(data => {
      allRecords = data;
      showStatus("âœ… ç¼“å­˜åŠ è½½æˆåŠŸï¼Œå…± " + allRecords.length + " æ¡è®°å½•", "success");
    })
    .catch(() => showStatus("ç¼“å­˜åŠ è½½å¤±è´¥", "error"));
  }
  
  function queryData() {
    const input = document.getElementById("trackingNumber").value.trim();
    if (!input) return alert("è¯·è¾“å…¥å¿«é€’å•å·");
    if (allRecords.length === 0) return showStatus("è¯·å…ˆåŠ è½½ç¼“å­˜", "error");
  
    let match = allRecords.find(item => item.trackingNumber === input);
    if (!match && input.length === 5) {
      match = allRecords.find(item => item.trackingNumber?.slice(-5) === input);
    }
    if (match) {
      lastFetched = match;
      matchedTrackingNumber = match.trackingNumber;
      updateDisplay(match);
    } else {
      showStatus("æœªåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°è¯¥å¿«é€’å•å·", "error");
    }
  }
  
  function updateDisplay(data) {
    document.getElementById("companyData").textContent = data.company || "-";
    document.getElementById("productData").textContent = data.product || "-";
    document.getElementById("customerData").textContent = data.customer || "-";
    document.getElementById("knownPrice").textContent = data.price || "-";
    showStatus("âœ… æŸ¥è¯¢æˆåŠŸ", "success");
  }
  
  function addToCache() {
    const price = document.getElementById("enteredPrice").value.trim();
    const number = matchedTrackingNumber || document.getElementById("trackingNumber").value.trim();
    if (!price || !lastFetched.company || !number) return showStatus("è¯·æŸ¥è¯¢å¹¶å¡«å†™é‡‘é¢", "error");
  
    const alreadyExists = pendingSubmissions.some(item => item.trackingNumber === number);
    if (alreadyExists) return showStatus("è¯¥å¿«é€’å•å·å·²å­˜åœ¨äºç¼“å­˜ä¸­", "error");
  
    pendingSubmissions.push({
      trackingNumber: number,
      company: lastFetched.company,
      customer: lastFetched.customer,
      product: lastFetched.product,
      enteredPrice: price
    });
    clearForm();
    renderPreview();
    showStatus("âœ… å·²åŠ å…¥ç¼“å­˜", "success");
  }
  
  function renderPreview() {
    const box = document.getElementById("previewList");
    box.innerHTML = "";
    pendingSubmissions.forEach((item, i) => {
      const line = document.createElement("div");
      line.innerHTML = `<div>${item.trackingNumber} - ${item.customer} - ${parseFloat(item.enteredPrice).toFixed(2)}</div><button class='del-btn' onclick='removeItem(${i})'>Ã—</button>`;
      box.appendChild(line);
    });
  
    updateCustomerDropdown();
  
    const sel = document.getElementById("ticketSelector");
    const selectedCustomer = sel.value;
    const stillExists = pendingSubmissions.some(r => r.customer === selectedCustomer);
    if (!stillExists) sel.value = "";
  
    renderTicket();
  }
  
  function updateCustomerDropdown() {
    const uniqueNames = [...new Set(pendingSubmissions.map(r => r.customer))];
    const sel = document.getElementById("ticketSelector");
    sel.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>';
    uniqueNames.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
  }
  
  function removeItem(i) {
    pendingSubmissions.splice(i, 1);
    renderPreview();
  }
  
  function clearCache() {
    pendingSubmissions = [];
    renderPreview();
    clearForm();
    document.getElementById("ticketSelector").value = "";
    renderTicket();
    document.getElementById("ticketPreview").innerHTML = "";
    showStatus("ç¼“å­˜ä¸è¡¨å•æ¸…é™¤æˆåŠŸ", "success");
  }
  
  function clearForm() {
    document.getElementById("trackingNumber").value = "";
    document.getElementById("enteredPrice").value = "";
    document.getElementById("companyData").textContent = "-";
    document.getElementById("productData").textContent = "-";
    document.getElementById("customerData").textContent = "-";
    document.getElementById("knownPrice").textContent = "-";
    matchedTrackingNumber = "";
    lastFetched = {};
  }
  
  function submitAll() {
    if (pendingSubmissions.length === 0) return showStatus("ç¼“å­˜ä¸ºç©º", "error");
    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "submitBatch", list: pendingSubmissions })
    })
    .then(r => r.json())
    .then(res => {
      if (res.message) {
        showStatus(res.message, "success");
        pendingSubmissions = [];
        renderPreview();
        clearForm();
        document.getElementById("ticketSelector").value = "";
        renderTicket();
      } else {
        showStatus("æäº¤å¤±è´¥", "error");
      }
    })
    .catch(() => showStatus("æäº¤å¼‚å¸¸", "error"));
  }
  
  function renderTicket() {
    const name = document.getElementById("ticketSelector").value;
    const area = document.getElementById("ticketPreview");
    const filtered = pendingSubmissions.filter(r => r.customer === name);
  
    if (!name || filtered.length === 0) {
      area.innerHTML = "";
      area.style.display = "none";
      return;
    }
  
    area.style.display = "block";
    let total = 0;
    const date = new Date().toLocaleDateString();
  
    let rowsHtml = "";
    filtered.forEach((r, i) => {
      const price = parseFloat(r.enteredPrice).toFixed(2);
      total += parseFloat(price);
      rowsHtml += `<tr>
        <td style='width:5%'>${i + 1}.</td>
        <td style='width:55%'>${r.trackingNumber}</td>
        <td style='width:20%;text-align:left;'>${r.company}</td>
        <td style='width:20%;text-align:right;'>${price}</td>
      </tr>
      <tr>
        <td></td><td colspan='3'>${r.product}</td>
      </tr>`;
    });
  
    const contentHeight = 400;
    const rowHeight = 50;
    const requiredRows = Math.floor((contentHeight - 120) / rowHeight);
    const emptyRows = Math.max(0, requiredRows - filtered.length);
  
    let fillerRows = "";
    for (let i = 0; i < emptyRows; i++) {
      fillerRows += `<tr><td colspan='4'>&nbsp;</td></tr>`;
    }
  
    let html = `<div class='ticket-header'>ä½“ç§¯è´¹ & åŒ…è£¹å·<br>æ—¥æœŸï¼š${date}<br>å®¢æˆ·ï¼š${name}</div><br><table class='ticket-table'>`;
    html += rowsHtml + fillerRows;
    html += `<tr><td colspan='4'><hr></td></tr>
             <tr><td colspan='4' class='ticket-summary'>åˆè®¡ï¼š${filtered.length} å•ï¼Œ${total.toFixed(2)}</td></tr>`;
    html += `</table>`;
    area.innerHTML = html;
  }
  
  function downloadTicketAsImage() {
    const target = document.getElementById("ticketPreview");
    html2canvas(target).then(canvas => {
      const link = document.createElement("a");
      link.download = "ticket.jpg";
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    });
  }
  
  function showStatus(msg, type = "success") {
    const bar = document.getElementById("statusBar");
    bar.textContent = msg;
    bar.className = "status-bar " + type;
    bar.style.display = "block";
  }
  </script>

<!-- ğŸ”æ‰«ç åŠŸèƒ½è„šæœ¬ -->
<script type="module">
  import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

  const videoElement = document.getElementById("scannerPreview");
  const codeReader = new BrowserMultiFormatReader();

  window.startScan = async function () {
    try {
      videoElement.style.display = "block";
      const devices = await codeReader.listVideoInputDevices();
      if (devices.length === 0) {
        showStatus("æœªæ£€æµ‹åˆ°æ‘„åƒå¤´", "error");
        return;
      }
      const selectedDeviceId = devices[0].deviceId;
      codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err, controls) => {
        if (result) {
          codeReader.reset();
          videoElement.style.display = "none";
          document.getElementById("trackingNumber").value = result.text;
          queryData();
        }
      });
    } catch (e) {
      showStatus("æ‰«ç åˆå§‹åŒ–å¤±è´¥", "error");
      console.error(e);
    }
  };
</script>

</body>
</html>
