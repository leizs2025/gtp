<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€’ä¸è®¢å•å½•å…¥</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background-color: #f2f2f2;
    }
    h2 { text-align: center; }
    label { display: block; margin-top: 16px; font-weight: bold; }
    input, select, button {
      width: 100%; padding: 12px; font-size: 1rem; margin-top: 5px; box-sizing: border-box;
    }
    .input-group { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    .input-row { display: flex; gap: 16px; width: 100%; flex-wrap: wrap; box-sizing: border-box; }
    .input-group input, .input-group select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
      padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px;
      height: 42px; background-color: #fff;
    }
    .input-group select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="5"><polygon points="0,0 10,0 5,5" fill="%23333"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 10px 5px;
      padding-right: 30px;
    }
    .input-row.three-cols {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
.btn-group {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 24px;
}
    button.submit {
  font-size: 1.1rem;
  padding: 6px 10px;
  width: auto;
  min-width: 42px;
      border: none;
      color: white;
      border-radius: 6px;
    }
    .express { background: #28a745; }
    .order { background: #007acc; }
    .clear { background: #999; color: #fff; }
    button:hover { opacity: 0.9; cursor: pointer; }

    .form-container {
      max-width: 680px;
      margin: auto;
      background: #fffdf7;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .modal-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-box {
      background: #fff;
      padding: 24px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>

<style>
  .clear-icon {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 20px;
    cursor: pointer;
    z-index: 10;
    color: #888;
  }
  .clear-icon:hover {
    color: #d33;
  }
  .form-wrapper {
    position: relative;
  }
</style>

</head>
<body>
  <div class="form-wrapper">
  <div class="clear-icon" onclick="clearForm()" title="æ¸…ç©ºè¡¨å•">ğŸ§¹</div>
  <div class="form-container">
    <h2>ğŸ“¦ å¿«é€’ä¸è®¢å•å½•å…¥</h2>
    <div class="input-row">
      <div class="input-group">
        <label for="orderNumber">è®¢å•å·</label>
        <input type="text" id="orderNumber">
      </div>
      <div class="input-group">
        <label for="customer">å®¢æˆ·åç§°</label>
        <select id="customer">
          <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
          <option value="å’ªé›ª">å’ªé›ª</option>
          <option value="Annie">Annie</option>
          <option value="HKS">HKS</option>
          <option value="JFL">JFL</option>
          <option value="é¾™">é¾™</option>
          <option value="æƒ ">æƒ </option>
          <option value="å§">å§</option>
          <option value="é˜¿å¦¹">é˜¿å¦¹</option>
          <option value="è‡ªå·±">è‡ªå·±</option>
          <option value="é˜¿æ–°">é˜¿æ–°</option>
          <option value="é—ºèœœ">é—ºèœœ</option>
          <option value="ä»»">ä»»</option>
          <option value="p">p</option>
          <option value="lok">lok</option>
        </select>
      </div>
    </div>
    <div class="input-row">
      <div class="input-group">
        <label for="trackingNumber">å¿«é€’å•å·</label>
        <input type="text" id="trackingNumber">
      </div>
      <div class="input-group">
        <label for="company">å¿«é€’å…¬å¸</label>
        <select id="company">
          <option value="">è¯·é€‰æ‹©å¿«é€’å…¬å¸</option>
          <option value="é¡ºä¸°">é¡ºä¸°</option>
          <option value="åœ†é€š">åœ†é€š</option>
          <option value="ä¸­é€š">ä¸­é€š</option>
          <option value="ç”³é€š">ç”³é€š</option>
          <option value="é‚®æ”¿">é‚®æ”¿</option>
          <option value="éŸµè¾¾">éŸµè¾¾</option>
          <option value="å¾·é‚¦">å¾·é‚¦</option>
          <option value="å®‰èƒ½">å®‰èƒ½</option>
          <option value="æå…”">æå…”</option>
          <option value="äº¬å¹¿">äº¬å¹¿</option>
          <option value="ä¼˜é€Ÿ">ä¼˜é€Ÿ</option>
          <option value="äº¬ä¸œ">äº¬ä¸œ</option>
          <option value="EMS">EMS</option>
          <option value="è”æ˜Šé€š">è”æ˜Šé€š</option>
        </select>
      </div>
    </div>
    <div class="input-row">
      <div class="input-group">
        <label for="product">å•†å“å</label>
        <input type="text" id="product">
      </div>
    </div>
    <div class="input-row three-cols">
      <div class="input-group">
        <label for="quantity">æ•°é‡</label>
        <input type="number" id="quantity">
      </div>
      <div class="input-group">
        <label for="price">å•ä»·</label>
        <input type="number" id="price">
      </div>
      <div class="input-group">
        <label for="foreignShipping">å¿«é€’è´¹</label>
        <input type="number" id="foreignShipping">
      </div>
    </div>
  <div id="summary" style="margin-top: 18px; font-weight: bold; text-align: right;">
    å°è®¡: <span id="subtotal">0.00</span>  | æ€»è®¡: <span id="total">0.00</span>
  </div>
  <div class="btn-group">
    <button class="submit" title="ç¼“å­˜å¿«é€’" onclick="cacheExpress()">ğŸ’¾</button>
    <button class="submit" title="æŸ¥çœ‹å¿«é€’ç¼“å­˜" onclick="previewExpressCache()">ğŸ‘ï¸</button>
    <button class="submit" title="ç¼“å­˜è®¢å•" onclick="cacheOrder()">ğŸ’¾</button>
    <button class="submit" title="æŸ¥çœ‹è®¢å•ç¼“å­˜" onclick="previewOrderCache()">ğŸ‘ï¸</button>
   </div>
  <div class="btn-group">
    <button class="submit" title="ä¸Šä¼ å¿«é€’è‰ç¨¿" onclick="uploadCachedExpress()">ğŸ“¦</button>
    <button class="submit" title="ä¸‹è½½å¿«é€’è‰ç¨¿" onclick="downloadCachedExpress()">ğŸ—‚ï¸</button>
    <button class="submit" title="ä¸Šä¼ è®¢å•è‰ç¨¿" onclick="uploadCachedOrders()">ğŸ“</button>
    <button class="submit" title="ä¸‹è½½è®¢å•è‰ç¨¿" onclick="downloadCachedOrders()">ğŸ—‚ï¸</button>
   </div>
</div>
<!-- âœ… å¿«é€’ç¼“å­˜å¼¹çª— -->
  <div id="expressCacheModal" class="modal-mask">
    <div class="modal-box">
      <h3>ğŸ“¦ ç¼“å­˜å¿«é€’é¢„è§ˆ</h3>
      <form id="expressCacheForm">
        <ul id="expressCacheList" style="list-style:none; padding-left:0;"></ul>
        <div style="margin-top:20px; text-align:right;">
          <button type="button" onclick="submitSelectedExpresses()">âœ… æäº¤æ‰€é€‰</button>
          <button type="button" onclick="closeExpressModal()">å…³é—­</button>
        </div>
      </form>
    </div>
  </div>
  <!-- âœ… è®¢å•ç¼“å­˜å¼¹çª— -->
  <div id="orderCacheModal" class="modal-mask">
    <div class="modal-box">
      <h3>ğŸ§¾ ç¼“å­˜è®¢å•é¢„è§ˆ</h3>
      <form id="orderCacheForm">
        <ul id="orderCacheList" style="list-style:none; padding-left:0;"></ul>
        <div style="margin-top:20px; text-align:right;">
          <button type="button" onclick="submitSelectedOrders()">âœ… æäº¤æ‰€é€‰</button>
          <button type="button" onclick="closeOrderModal()">å…³é—­</button>
        </div>
      </form>
    </div>
  </div>
<script>
// ğŸŒ URL é…ç½®
const EXPRESS_WORKER_URL = "https://yjtee.jeenty.workers.dev/express";
const ORDER_WORKER_URL = "https://yjtee.jeenty.workers.dev/order";

// æ­£å¼æäº¤ URL
const EXPRESS_URL = "https://wandering-moon-bdc2.jeenty.workers.dev/gas3";
const ORDER_URL = "https://wandering-moon-bdc2.jeenty.workers.dev/gas4";

// ğŸ“¦ ç¼“å­˜é”®
const EXPRESS_CACHE_KEY = "expressCache";
const ORDER_CACHE_KEY = "orderCache";

// è·å–è¡¨å•å­—æ®µå€¼
function getField(id) {
    return document.getElementById(id)?.value.trim() || '';
}

// è®¾ç½®è¡¨å•å­—æ®µå€¼
function setField(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = val;
}

// è½¬æ¢ä¸ºæ•°å­—ï¼Œéæ³•å€¼è¿”å›0
function parseOrZero(val) {
    return parseFloat(val) || 0;
}

// æ¸…ç©ºè¡¨å•
function clearForm() {
    document.querySelectorAll("input, select").forEach(el => el.value = "");
    updateSummary();
}

// ğŸ’° å®¢æˆ·åŠ ä»·ç‡ (å…¨å±€å®šä¹‰)
const MARKUP_MAP = {
    "å’ªé›ª": 0.10, "Annie": 0.19, "HKS": 0.16, "JFL": 0.19,
    "é¾™": 0.00, "æƒ ": 0.15, "å§": 0.015, "é˜¿å¦¹": 0.015,
    "è‡ªå·±": 0.19, "é˜¿æ–°": 0.00, "é—ºèœœ": 0.15
};

// å®æ—¶è®¡ç®—å°è®¡å’Œæ€»è®¡
function updateSummary() {
    const quantity = parseOrZero(getField("quantity"));
    const price = parseOrZero(getField("price"));
    const fee = parseOrZero(getField("foreignShipping"));
    const customer = getField("customer");

    const { subtotal, total } = calculateTotal(quantity, price, fee, customer);
    
    // âœ… ç›´æ¥æ›´æ–° DOM
    document.getElementById("subtotal").textContent = subtotal;
    document.getElementById("total").textContent = total;
}

// è®¡ç®—å°è®¡å’Œæ€»è®¡ (ä¼˜åŒ–ç‰ˆ)
function calculateTotal(quantity, price, fee, customer) {
    const subtotal = (quantity * price) + fee;
    const markupRate = MARKUP_MAP[customer] || 0;

    // **ä¼˜åŒ–å…¬å¼:** æ€»è®¡ = (å°è®¡ / 1.65) * (1 + åŠ ä»·ç‡)
    const total = (subtotal / 1.72) * (1 + markupRate);
    
    // âœ… æ ¼å¼åŒ–ä¸¤ä½å°æ•°
    return {
        subtotal: subtotal.toFixed(2),
        total: total.toFixed(2)
    };
}

// âœ… ç¡®ä¿è¡¨å•è¾“å…¥è§¦å‘ updateSummary()
function bindSummaryEvents() {
    const fields = ["quantity", "price", "foreignShipping", "customer"];
    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener("input", updateSummary);
            el.addEventListener("change", updateSummary);
        }
    });
}

// âœ… é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
document.addEventListener("DOMContentLoaded", bindSummaryEvents);


// ç¼–è¾‘è®¢å•ç¼“å­˜
function editOrderCache(index) {
    const cache = JSON.parse(localStorage.getItem("orderCache") || "[]");
    const item = cache[index];
    if (!item) return alert("æ‰¾ä¸åˆ°è¯¥è®¢å•");

    // å¡«å……è¡¨å•æ•°æ®
    setField("orderNumber", String(item.orderNumber || "").trim());
    setField("trackingNumber", String(item.trackingNumber || "").trim());
    setField("company", item.company || "");
    setField("customer", item.customer|| "");
    setField("product", item.product|| "");
    setField("quantity", item.quantity|| "");
    setField("price", item.price|| "");
    setField("foreignShipping", item.foreignShipping|| "");
    updateSummary();

    // ä»ç¼“å­˜ä¸­ç§»é™¤å·²ç¼–è¾‘çš„é¡¹
    cache.splice(index, 1);
    localStorage.setItem("orderCache", JSON.stringify(cache));

    alert("è®¢å•å·²åŠ è½½åˆ°è¡¨å•ï¼Œè¯·ä¿®æ”¹åé‡æ–°ç¼“å­˜");
    closeOrderModal();
}

// âœ… ä¿®æ­£ç‰ˆ editExpressCache (ç¡®ä¿è®¢å•å·å¡«å……)
function editExpressCache(index) {
    const cache = JSON.parse(localStorage.getItem("expressCache") || "[]");
    const item = cache[index];
    if (!item) return alert("æ‰¾ä¸åˆ°è¯¥å¿«é€’");

    // âœ… å¡«å……è¡¨å•æ•°æ® (ç¡®ä¿è®¢å•å·)
    setField("orderNumber", String(item.orderNumber || "").trim());
    setField("trackingNumber", String(item.trackingNumber || "").trim());
    setField("company", item.company || "");
    setField("customer", item.customer || "");
    setField("product", item.product || "");
    setField("quantity", item.quantity || "");
    setField("price", item.price || "");
    setField("foreignShipping", item.foreignShipping || "");
    updateSummary();

    // âœ… ä»ç¼“å­˜ä¸­ç§»é™¤å·²ç¼–è¾‘çš„é¡¹ (ç¡®ä¿ä¸ä¼šé‡å¤)
    cache.splice(index, 1);
    localStorage.setItem("expressCache", JSON.stringify(cache));

    alert("å¿«é€’å·²åŠ è½½åˆ°è¡¨å•ï¼Œè¯·ä¿®æ”¹åé‡æ–°ç¼“å­˜");
    closeExpressModal();
}


// ğŸ’¾ ç¼“å­˜å¿«é€’è‰ç¨¿ (ä¿®æ­£ç‰ˆ)
function cacheExpress() { 
    const orderNumber = String(getField("orderNumber")).trim(); 
    const trackingNumber = String(getField("trackingNumber")).trim();
    const customer = getField("customer");
    const company = getField("company");
    const product = getField("product");
    const quantity = parseOrZero(getField("quantity"));
    const price = parseOrZero(getField("price"));
    const foreignShipping = parseOrZero(getField("foreignShipping"));

    // âœ… ç¡®ä¿ cache æ˜¯ä¸€ä¸ªæ•°ç»„
    let cache = JSON.parse(localStorage.getItem(EXPRESS_CACHE_KEY) || "[]");
    if (!Array.isArray(cache)) cache = [];

    // âœ… åŠ å…¥ orderNumber
    cache.push({ 
        orderNumber: orderNumber || "",  // âœ… ç¡®ä¿åŒ…å«è®¢å•å·
        trackingNumber: trackingNumber || "", 
        customer: customer || "", 
        company: company || "", 
        product: product || "", 
        quantity: quantity.toString(), 
        price: price.toString(), 
        foreignShipping: foreignShipping.toString() 
    });

    localStorage.setItem(EXPRESS_CACHE_KEY, JSON.stringify(cache));
    alert("å¿«é€’è‰ç¨¿å·²ç¼“å­˜ âœ…");
   clearForm();
}

function previewOrderCache() {
    const list = JSON.parse(localStorage.getItem(ORDER_CACHE_KEY) || "[]");
    const container = document.getElementById("orderCacheList");
    if (!list.length) return alert("æš‚æ— ç¼“å­˜è®¢å•");

    // âœ… æ˜¾ç¤ºå•†å“å’Œå®¢æˆ·
    container.innerHTML = list.map((item, i) => `
        <li>
            <label>
                <input type='checkbox' name='orderIndex' value='${i}'>
                å•†å“: ${item.product || "æœªå¡«å†™"} | å®¢æˆ·: ${item.customer || "æœªå¡«å†™"} | å¿«é€’å•å·: ${item.trackingNumber || "æœªå¡«å†™"}
            </label>
            <button type='button' onclick='editOrderCache(${i})'>âœï¸ ä¿®æ”¹</button>
            <button type='button' onclick='deleteOrderCache(${i})'>ğŸ—‘ï¸ åˆ é™¤</button>
        </li>`).join("");

    document.getElementById("orderCacheModal").style.display = "flex";
}

// ğŸ’¾ ç¼“å­˜è®¢å•è‰ç¨¿
function cacheOrder() {
    const orderNumber = String(getField("orderNumber")).trim(); 
    const trackingNumber = getField("trackingNumber");
    const company = getField("company");
    const customer = getField("customer");
    const product = getField("product");
    const quantity = parseOrZero(getField("quantity"));
    const price = parseOrZero(getField("price"));
    const foreignShipping = parseOrZero(getField("foreignShipping"));

    if (!orderNumber) return alert("è®¢å•å·ä¸èƒ½ä¸ºç©º");

    const cache = JSON.parse(localStorage.getItem(ORDER_CACHE_KEY) || "[]");
    cache.push({ orderNumber, trackingNumber,company,customer, product, quantity, price, foreignShipping });
    localStorage.setItem(ORDER_CACHE_KEY, JSON.stringify(cache));
    alert("è®¢å•è‰ç¨¿å·²ç¼“å­˜ âœ…");
    clearForm();
}

// ğŸ“‹ é¢„è§ˆå¿«é€’ç¼“å­˜ (ä¿®æ­£ç‰ˆ)
function previewExpressCache() {
    const list = JSON.parse(localStorage.getItem(EXPRESS_CACHE_KEY) || "[]");
    const container = document.getElementById("expressCacheList");
    if (!list.length) return alert("æš‚æ— ç¼“å­˜å¿«é€’");

    container.innerHTML = list.map((item, i) => `
        <li>
            <label>
                <input type='checkbox' name='expressIndex' value='${i}'>
                å•†å“: ${item.product || "æœªå¡«å†™"} | å®¢æˆ·: ${item.customer || "æœªå¡«å†™"} | å¿«é€’å•å·: ${item.trackingNumber || "æœªå¡«å†™"}
            </label>
            <button type='button' onclick='editExpressCache(${i})'>âœï¸ ä¿®æ”¹</button>
            <button type='button' onclick='deleteExpressCache(${i})'>ğŸ—‘ï¸ åˆ é™¤</button>
        </li>`).join("");

    document.getElementById("expressCacheModal").style.display = "flex";
}



// âœ… åˆ é™¤è®¢å•ç¼“å­˜
function deleteOrderCache(index) {
    const cache = JSON.parse(localStorage.getItem(ORDER_CACHE_KEY) || "[]");
    if (index >= 0 && index < cache.length) {
        // **âš ï¸ ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ**
        cache.splice(index, 1);
        localStorage.setItem(ORDER_CACHE_KEY, JSON.stringify(cache));
        alert("è®¢å•å·²åˆ é™¤ âœ…");
        previewOrderCache(); // **åˆ·æ–°åˆ—è¡¨**
    }
}

// âœ… åˆ é™¤å¿«é€’ç¼“å­˜
function deleteExpressCache(index) {
    const cache = JSON.parse(localStorage.getItem(EXPRESS_CACHE_KEY) || "[]");
    if (index >= 0 && index < cache.length) {
        // **âš ï¸ ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ**
        cache.splice(index, 1);
        localStorage.setItem(EXPRESS_CACHE_KEY, JSON.stringify(cache));
        alert("å¿«é€’å·²åˆ é™¤ âœ…");
        previewExpressCache(); // **åˆ·æ–°åˆ—è¡¨**
    }
}
  
function emptyIfZero(value) {
    return (value === 0 || value === "0") ? null : value;
}

function omitZeroFields(obj) {
    const result = {};
    for (const key in obj) {
        const val = obj[key];
        if (val !== 0 && val !== "0" && val !== "") {
            result[key] = val;
        }
    }
    return result;
}
  
async function submitSelectedExpresses() {
    const selected = [...document.querySelectorAll("input[name='expressIndex']:checked")]
        .map(el => parseInt(el.value));
    let list = JSON.parse(localStorage.getItem("expressCache") || "[]");
    let successOrderNumbers = [];

    for (let i of selected) {
        const item = list[i];

        const { total } = calculateTotal(
            parseOrZero(item.quantity),
            parseOrZero(item.price),
            parseOrZero(item.foreignShipping),
            item.customer
        );

        let payloadRaw = {
            customer: item.customer || "",
            orderNumber: item.orderNumber || "",
            trackingNumber: item.trackingNumber || "",
            company: item.company || "",
            product: item.product || "",
            total: emptyIfZero(total)
        };

        let payload = emptyIfZero(payloadRaw); // âœ… è¿‡æ»¤ 0 å€¼å­—æ®µ

        try {
            const res = await fetch(EXPRESS_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            console.log("ğŸ“¦ æäº¤è¿”å›:", result);

            if (result.success || result.message?.includes("æˆåŠŸ")) {
                successOrderNumbers.push(item.orderNumber);
            }

        } catch (err) {
            console.error("ğŸ›‘ å¿«é€’æäº¤å¤±è´¥:", err);
        }
    }

    list = list.filter(item => !successOrderNumbers.includes(String(item.orderNumber).trim()));
    localStorage.setItem("expressCache", JSON.stringify(list));

    if (successOrderNumbers.length > 0) {
        console.log("ğŸ“ æ­£åœ¨åˆ é™¤å¿«é€’è‰ç¨¿:", successOrderNumbers);
        fetch(EXPRESS_WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                action: "delete",
                type: "express",
                orderNumbers: successOrderNumbers
            })
        })
        .then(res => res.json())
        .then(r => {
            alert(`âœ… æˆåŠŸæäº¤å¹¶åˆ é™¤ ${successOrderNumbers.length} æ¡å¿«é€’ âœ…`);
        })
        .catch(err => {
            console.error("ğŸ›‘ è‰ç¨¿åˆ é™¤å¤±è´¥:", err);
            alert("è‰ç¨¿åˆ é™¤å¤±è´¥");
        });
    } else {
        alert("âš ï¸ æ²¡æœ‰æˆåŠŸæäº¤çš„å¿«é€’è‰ç¨¿");
    }

    closeExpressModal();
}



async function submitSelectedOrders() {
    const selected = [...document.querySelectorAll("input[name='orderIndex']:checked")]
        .map(el => parseInt(el.value));
    let list = JSON.parse(localStorage.getItem("orderCache") || "[]");
    let successOrderNumbers = [];

    for (let i of selected) {
        const item = list[i];

        const { subtotal, total } = calculateTotal(
            parseOrZero(item.quantity),
            parseOrZero(item.price),
            parseOrZero(item.foreignShipping),
            item.customer
        );

        // âœ… æ„é€ æ‰å¹³ç»“æ„ï¼ˆGAS4 ä¼šæ ¹æ® customer æ˜ å°„ columns è‡ªåŠ¨æ’ï¼‰
       const payload = {
 	 customer: item.customer || "",
  	trackingNumber: item.trackingNumber || "",
  	orderNumber: item.orderNumber || "",
  	product: item.product || "",
  	quantity: emptyIfZero(item.quantity),
  	price: emptyIfZero(item.price),
  	foreignShipping: emptyIfZero(item.foreignShipping),
  	subtotal: emptyIfZero(subtotal),
 	 total: emptyIfZero(total)
};


        try {
            const res = await fetch(ORDER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            console.log("ğŸ“¤ è®¢å•æäº¤è¿”å›:", result);

            if (result.success || result.message?.includes("æˆåŠŸ")) {
                successOrderNumbers.push(item.orderNumber);
            }

        } catch (err) {
            console.error("ğŸ›‘ è®¢å•æäº¤å¤±è´¥:", err);
        }
    }

    // âœ… æ¸…ç†æœ¬åœ°ç¼“å­˜
    list = list.filter(item => !successOrderNumbers.includes(String(item.orderNumber).trim()));
    localStorage.setItem("orderCache", JSON.stringify(list));

    // âœ… åŸå§‹è‰ç¨¿åˆ é™¤é€»è¾‘ä¿ç•™
    if (successOrderNumbers.length > 0) {
        console.log("ğŸ“ æ­£åœ¨åˆ é™¤è®¢å•è‰ç¨¿:", successOrderNumbers);
        fetch(ORDER_WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                action: "delete",
                type: "order",
                orderNumbers: successOrderNumbers
            })
        })
        .then(res => res.json())
        .then(r => {
            console.log("âœ… è®¢å•è‰ç¨¿åˆ é™¤è¿”å›:", r);
            alert(`âœ… æˆåŠŸæäº¤å¹¶åˆ é™¤ ${successOrderNumbers.length} æ¡è®¢å• âœ…`);
        })
        .catch(err => {
            console.error("ğŸ›‘ è‰ç¨¿åˆ é™¤å¤±è´¥:", err);
            alert("è®¢å•è‰ç¨¿åˆ é™¤å¤±è´¥");
        });
    } else {
        alert("âš ï¸ æ²¡æœ‰æˆåŠŸæäº¤çš„è®¢å•è‰ç¨¿");
    }

    closeOrderModal();
}



// â¬†ï¸ ä¸Šä¼ å¿«é€’è‰ç¨¿ (å…è®¸ç©ºå€¼)
function uploadCachedExpress() {
    const cache = JSON.parse(localStorage.getItem(EXPRESS_CACHE_KEY) || "[]");
    if (!cache.length) return alert("æ²¡æœ‰å¿«é€’è‰ç¨¿");

    fetch(EXPRESS_WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cache)
    })
    .then(res => {
        if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯ï¼š" + res.status);
        return res.json();
    })
    .then(r => {
        alert(r.message || `å·²ä¸Šä¼  ${cache.length} æ¡å¿«é€’è‰ç¨¿ âœ…`);
        localStorage.removeItem(EXPRESS_CACHE_KEY);  // âœ… æ¸…é™¤å¿«é€’ç¼“å­˜
    })
    .catch(err => {
        console.error("ğŸ›‘ å¿«é€’è‰ç¨¿ä¸Šä¼ å¤±è´¥:", err);
        alert("å¿«é€’è‰ç¨¿ä¸Šä¼ å¤±è´¥ï¼š" + err.message);
    });
}

// â¬†ï¸ ä¸Šä¼ è®¢å•è‰ç¨¿ (å…è®¸ç©ºå€¼)
function uploadCachedOrders() {
    const cache = JSON.parse(localStorage.getItem(ORDER_CACHE_KEY) || "[]");
    if (!cache.length) return alert("æ²¡æœ‰è®¢å•è‰ç¨¿");

    fetch(ORDER_WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cache)
    })
    .then(res => {
        if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯ï¼š" + res.status);
        return res.json();
    })
    .then(r => {
        // console.log("ğŸ“ ä¸Šä¼ è¿”å›ç»“æœ:", r);
        localStorage.removeItem(ORDER_CACHE_KEY);  // âœ… æ¸…é™¤è®¢å•ç¼“å­˜ï¼ˆå¿…é¡»æ”¾åœ¨ alert å‰ï¼‰
        alert(r.message || `å·²ä¸Šä¼  ${cache.length} æ¡è®¢å•è‰ç¨¿ âœ…`);
    })
    .catch(err => {
        console.error("ğŸ›‘ è®¢å•è‰ç¨¿ä¸Šä¼ å¤±è´¥:", err);
        alert("è®¢å•è‰ç¨¿ä¸Šä¼ å¤±è´¥ï¼š" + err.message);
    });
}

// âœ… è®¢å•å»é‡ - ä¸‹è½½å¹¶èåˆè‰ç¨¿
function downloadCachedOrders() {
    fetch(ORDER_WORKER_URL + "?downloadCache=1")
        .then(res => res.json())
        .then(data => {
            const rawData = data.slice(1);  // **è·³è¿‡è¡¨å¤´**

            // **è¡¥å…¨ç¼ºå¤±åˆ—**
            const downloadedData = rawData.map(item => ({
                orderNumber: item.col1 || "",         // è®¢å•å·
                trackingNumber: item.col2 || "",      // å¿«é€’å•å· (å…è®¸ä¸ºç©º)
                customer: item.col3 || "",            // å®¢æˆ·åç§°
                company: item.col4 || "",             // å¿«é€’å…¬å¸ (å…è®¸ä¸ºç©º)
                product: item.col5 || "",             // å•†å“å
                quantity: item.col6 || "0",           // æ•°é‡ (é»˜è®¤ 0)
                price: item.col7 || "0.00",           // å•ä»· (é»˜è®¤ 0.00)
                foreignShipping: item.col8 || "0.00"  // å¿«é€’è´¹ (é»˜è®¤ 0.00)
            }));

            // **åŠ è½½æœ¬åœ°ç¼“å­˜**
            const currentCache = JSON.parse(localStorage.getItem(ORDER_CACHE_KEY) || "[]");

            // **å»é‡é€»è¾‘ - é¿å…é‡å¤è®¢å•**
            const mergedData = [
                ...currentCache,
                ...downloadedData.filter(downloadedItem => {
                    return !currentCache.some(cachedItem => 
                        cachedItem.orderNumber === downloadedItem.orderNumber &&
                        cachedItem.trackingNumber === downloadedItem.trackingNumber
                    );
                })
            ];

            // **ä¿å­˜èåˆåçš„æ•°æ®**
            if (mergedData.length > 0) {
                localStorage.setItem(ORDER_CACHE_KEY, JSON.stringify(mergedData));
                alert("è®¢å•è‰ç¨¿å·²åŒæ­¥ âœ…");
            } else {
                alert("æ²¡æœ‰å¯åŒæ­¥çš„è®¢å•è‰ç¨¿");
            }
        })
        .catch(err => {
            console.error("ğŸ›‘ ä¸‹è½½è®¢å•è‰ç¨¿å¤±è´¥:", err);
            alert("è®¢å•è‰ç¨¿åŒæ­¥å¤±è´¥");
        });
}


// ğŸ”„ åŒæ­¥å¿«é€’è‰ç¨¿ (ä¿®æ­£ç‰ˆ)
function downloadCachedExpress() {
    fetch(EXPRESS_WORKER_URL + "?downloadCache=1")
        .then(res => res.json())
        .then(data => {
            // âœ… åˆ—åæ˜ å°„ (ç¡®ä¿åŒ…å« orderNumber)
             const mappedData = data.slice(1).map(item => ({
                orderNumber: item.col1 || "",         // è®¢å•å·
                trackingNumber: item.col2 || "",      // å¿«é€’å•å·
                customer: item.col3 || "",            // å®¢æˆ·åç§°
                company: item.col4 || "",             // å¿«é€’å…¬å¸
                product: item.col5 || "",             // å•†å“å
                quantity: item.col6 || "",            // æ•°é‡
                price: item.col7 || "",               // å•ä»·
                foreignShipping: item.col8 || ""      // å¿«é€’è´¹
            }));

            // âœ… è¿‡æ»¤æ‰å®Œå…¨ä¸ºç©ºçš„æ•°æ®
            const validData = mappedData.filter(item => 
                Object.values(item).some(v => v !== "" && v !== null && v !== undefined)
            );

            // âœ… ç¡®ä¿ç¼“å­˜ä¸€è‡´æ€§
            if (validData.length > 0) {
                localStorage.setItem(EXPRESS_CACHE_KEY, JSON.stringify(validData));
                alert("å¿«é€’è‰ç¨¿å·²åŒæ­¥ âœ…");
            } else {
                alert("æ²¡æœ‰å¯åŒæ­¥çš„å¿«é€’è‰ç¨¿");
            }
        })
        .catch(err => {
            console.error("ğŸ›‘ ä¸‹è½½å¿«é€’è‰ç¨¿å¤±è´¥:", err);
            alert("å¿«é€’è‰ç¨¿åŒæ­¥å¤±è´¥");
        });
}




// ğŸ”’ å…³é—­å¼¹çª—
function closeOrderModal() {
    document.getElementById("orderCacheModal").style.display = "none";
}

function closeExpressModal() {
    document.getElementById("expressCacheModal").style.display = "none";
}
</script>

</body>
</html>
